<?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\ResponseHeaderBag;
use Symfony\Component\Routing\Annotation\Route;
use Doctrine\DBAL\Connection;
use OpenSpout\Writer\XLSX\Writer;
use OpenSpout\Common\Entity\Style\Style;
use OpenSpout\Common\Entity\Style\Color;
use OpenSpout\Common\Entity\Row;

class ExportOrdersController extends AbstractController
{
    #[Route('/export-orders', name: 'app_export_orders')]
    public function export(Connection $connection): Response
    {
        $sql = "
            SELECT 
                o.id,
                c.name as customer_name,
                o.uploaded_at,
                GROUP_CONCAT(d.name SEPARATOR ', ') as dishes
            FROM orders o
            LEFT JOIN customer c ON o.customer_id = c.id
            LEFT JOIN order_entity_dish od ON o.id = od.order_entity_id
            LEFT JOIN dish d ON od.dish_id = d.id
            GROUP BY o.id
            ORDER BY o.uploaded_at DESC
        ";

        $orders = $connection->executeQuery($sql)->fetchAllAssociative();

        $writer = new Writer();
        $tempFile = tempnam(sys_get_temp_dir(), 'orders_') . '.xlsx';
        $writer->openToFile($tempFile);


        $headerStyle = (new Style())
            ->setFontBold()
            ->setFontSize(14)
            ->setFontColor(Color::WHITE)
            ->setBackgroundColor(Color::rgb(0, 102, 204));

        $writer->addRow(Row::fromValues([
            'ID заказа',
            'Клиент',
            'Блюда',
            'Дата и время'
        ], $headerStyle));

        // Данные
        foreach ($orders as $order) {
            $writer->addRow(Row::fromValues([
                $order['id'],
                $order['customer_name'] ?? 'Аноним',
                $order['dishes'] ?? '—',
                $order['uploaded_at']
                    ? (new \DateTime($order['uploaded_at']))->format('d.m.Y H:i')
                    : '—'
            ]));
        }

        $writer->close();


        $response = new Response(file_get_contents($tempFile));
        $disposition = $response->headers->makeDisposition(
            ResponseHeaderBag::DISPOSITION_ATTACHMENT,
            'Заказы_' . date('Y-m-d_H-i') . '.xlsx'
        );

        $response->headers->set('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        $response->headers->set('Content-Disposition', $disposition);


        @unlink($tempFile);

        return $response;
    }
}
